#!/usr/bin/env bash
set -euo pipefail

INDIR="pokemon_data"
CSV="pokemon_report.csv"

# compgen -G to check glob existence without failing if none match
if ! compgen -G "${INDIR}/*.json" > /dev/null; then
  echo "No JSON files found in $INDIR. Run batchProcessing-0x02 first."
  exit 1
fi

echo "Name,Height (m),Weight (kg)" > "$CSV"   # CSV header

for f in "${INDIR}"/*.json; do
  name=$(jq -r '.name' "$f" | awk '{print toupper(substr($0,1,1)) substr($0,2)}')
  h_dm=$(jq -r '.height' "$f")
  w_hg=$(jq -r '.weight' "$f")
  h_m=$(awk -v h="$h_dm" 'BEGIN{printf "%.1f", h/10}')
  w_kg=$(awk -v w="$w_hg" 'BEGIN{printf "%.1f", w/10}')
  echo "${name},${h_m},${w_kg}" >> "$CSV"
done

echo "CSV Report generated at: $CSV"
echo
cat "$CSV"
echo

# -F, sets CSV delimiter. NR>1 skips header.
awk -F, 'NR>1 {h+=$2; w+=$3; n++} END{
  printf "Average Height: %.2f m\nAverage Weight: %.2f kg\n", h/n, w/n
}' "$CSV"
